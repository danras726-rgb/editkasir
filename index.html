<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <!-- Content Security Policy Wajib untuk Cordova -->
  <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline'; media-src *; img-src * data: content:;">
  <title>Kasir CAKSABAR</title>
  
  <!-- SCRIPT CORDOVA (Akan aktif setelah di-build jadi APK) -->
  <script src="cordova.js"></script> 
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{--muted:#64748b;--accent:#0891b2;--accent-dark:#0e7490;--bg:#f1f5f9;--card:#ffffff;--red:#ef4444;--orange:#f59e0b;--green:#10b981}
    *{box-sizing:border-box;font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif}
    body{margin:0;background:var(--bg);color:#0f172a;padding:12px;padding-bottom:80px; -webkit-font-smoothing: antialiased;}
    
    /* === LAYOUT RESPONSIVE SYSTEM === */
    .app { max-width: 100%; margin: 0 auto; }
    .layout-grid { display: flex; flex-direction: column; gap: 24px; }
    @media (min-width: 900px) {
      .app { max-width: 1280px; padding: 20px; }
      .layout-grid { display: grid; grid-template-columns: 1fr 400px; gap: 32px; align-items: start; }
      .sidebar-column { position: sticky; top: 20px; height: fit-content; }
      .menu-grid { grid-template-columns: repeat(3, 1fr) !important; }
      body { padding-bottom: 40px; }
    }
    @media (min-width: 600px) and (max-width: 899px) {
      .app { max-width: 768px; }
      .menu-grid { grid-template-columns: repeat(3, 1fr) !important; }
    }

    /* === HEADER & PRINTER STATUS === */
    header { margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; background: var(--card); padding: 16px 20px; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    h1 { font-size: 20px; margin: 0; color: var(--accent); font-weight: 800; letter-spacing: -0.5px; }
    .sub { font-size: 12px; color: var(--muted); margin-top: 2px; }
    
    .printer-status-btn { 
        display: flex; align-items: center; gap: 6px; 
        background: #fee2e2; color: #991b1b; 
        border: 1px solid #fca5a5; 
        padding: 6px 12px; border-radius: 8px; 
        font-size: 12px; font-weight: 700; cursor: pointer; 
    }
    .printer-status-btn.connected { background: #dcfce7; color: #166534; border-color: #86efac; }
    
    .header-btn { background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 10px; padding: 8px 12px; font-size: 18px; cursor: pointer; color: #334155; }

    /* === COMPONENTS === */
    .card-box { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 24px; }

    /* Stats */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 0; }
    .stat-card { background: #f8fafc; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; }
    .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
    .stat-val { font-size: 20px; font-weight: 800; margin-top: 6px; color: #0f172a; }

    /* AI Input */
    .ai-section { background: linear-gradient(to bottom right, #ffffff, #f0f9ff); border-color: #bae6fd; }
    .ai-box { width: 100%; border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; font-size: 15px; margin-top: 12px; transition: 0.2s; resize: none; font-family: inherit; line-height: 1.5; }
    .ai-box:focus { border-color: var(--accent); outline: none; background: white; box-shadow: 0 0 0 4px rgba(8, 145, 178, 0.1); }
    .ai-hint { font-size: 12px; color: var(--muted); margin-top: 12px; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 8px; line-height: 1.6; border: 1px solid #e2e8f0; }
    .code-tag { font-family: 'Courier New', monospace; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-weight: 700; color: #0f172a; font-size: 11px; border: 1px solid #cbd5e1; }

    /* Menu Grid */
    .section-title { font-weight: 800; margin: 0 0 16px; display: flex; justify-content: space-between; align-items: center; font-size: 18px; color: #1e293b; border-left: 4px solid var(--accent); padding-left: 12px; }
    .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .menu-item { background: var(--card); border: 1px solid #e2e8f0; border-radius: 14px; padding: 16px; position: relative; transition: all 0.2s; user-select: none; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: space-between; height: 100%; min-height: 110px; }
    .menu-item:active { transform: scale(0.98); background: #f8fafc; }
    .m-name { font-weight: 600; font-size: 15px; line-height: 1.4; margin-bottom: 8px; color: #334155; }
    
    .menu-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 8px; }
    .m-price { font-size: 14px; color: var(--accent); font-weight: 700; }
    
    .add-btn-simple {
        background: var(--accent); color: white; border-radius: 8px; padding: 6px 12px;
        font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 4px; border: none;
    }
    
    .qty-controls { display: flex; align-items: center; background: #f1f5f9; border-radius: 8px; border: 1px solid #e2e8f0; height: 30px; }
    .qty-btn { width: 28px; height: 100%; display: flex; align-items: center; justify-content: center; background: #fff; border: none; font-weight: bold; cursor: pointer; font-size: 16px; }
    .qty-btn.minus { color: var(--red); border-right: 1px solid #e2e8f0; }
    .qty-btn.plus { color: var(--green); border-left: 1px solid #e2e8f0; }
    .qty-val { padding: 0 8px; font-size: 13px; font-weight: 700; min-width: 24px; text-align: center; color: #0f172a; }

    /* Cart */
    .cart-wrapper { background: var(--card); border-radius: 20px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
    .cart-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed #cbd5e1; font-size: 14px; align-items: center; }
    .c-name { flex: 1; font-weight: 600; color: #334155; }
    .c-qty { color: var(--muted); margin-right: 12px; font-weight: 700; background: #f1f5f9; padding: 4px 10px; border-radius: 6px; font-size: 12px; border: 1px solid #e2e8f0; }
    
    .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; background: var(--accent); color: white; font-weight: 700; font-size: 15px; cursor: pointer; margin-top: 12px; box-shadow: 0 4px 6px -1px rgba(8,145,178,0.3); display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn.secondary { background: #f1f5f9; color: #475569; box-shadow: none; border: 1px solid #cbd5e1; }
    
    /* Transaction History Table */
    .table-container { background: #fff; border-radius: 16px; padding: 0; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; color: var(--muted); padding: 14px 16px; font-weight: 700; border-bottom: 2px solid #e2e8f0; background: #f8fafc; font-size: 12px; text-transform: uppercase; }
    td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; color: #334155; vertical-align: middle; }
    
    /* Action Buttons */
    .action-btn { border: none; background: none; cursor: pointer; padding: 6px; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center; }
    .action-btn.edit { color: var(--orange); background: #fff7ed; border: 1px solid #ffedd5; margin-right: 6px; }
    .action-btn.del { color: var(--red); background: #fef2f2; border: 1px solid #fee2e2; }

    /* Modal Styles */
    .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); display: none; align-items: center; justify-content: center; z-index: 999; backdrop-filter: blur(4px); padding: 20px; }
    .modal-card { background: white; width: 100%; max-width: 380px; padding: 24px; border-radius: 24px; max-height: 90vh; overflow-y: auto; }
    input.money { width: 100%; padding: 16px; font-size: 24px; text-align: center; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 16px; font-weight: 700; color: #0f172a; }
    
    /* Printer List in Modal */
    #deviceList { list-style: none; padding: 0; margin: 0; }
    #deviceList li { padding: 14px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    #deviceList li:active { background: #f0f9ff; }

    /* Full Page Report */
    #reportPage { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg); z-index: 2000; display: none; flex-direction: column; overflow-y: auto; padding: 0; }
    .report-header { background: white; padding: 16px 20px; position: sticky; top: 0; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); z-index: 10; }
    .report-container { padding: 20px; max-width: 800px; margin: 0 auto; width: 100%; }
    .report-qty { font-weight: 700; color: var(--accent); font-size: 16px; }
    .report-group-header { background: #f8fafc; font-weight: 800; color: #334155; padding: 12px 16px; font-size: 13px; text-transform: uppercase; border-top: 2px solid #e2e8f0; }

    /* Print Styles (Fallback System Print) */
    @media print {
      body * { visibility: hidden; }
      #receipt-area, #receipt-area * { visibility: visible; }
      #receipt-area { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
    }
    #receipt-area { display: none; font-family: monospace; max-width: 300px; margin: 0 auto; }
  </style>
</head>
<body>

<div class="app">
  <header>
    <div>
      <h1>Kasir CAKSABAR</h1>
      <div class="sub">Cordova Hybrid App</div>
    </div>
    
    <div style="display:flex; gap:8px;">
        <!-- TOMBOL STATUS PRINTER -->
        <div id="btnPrinter" class="printer-status-btn" onclick="scanPrinters()">
            <span id="iconPrinter">üîå</span>
            <span id="textPrinter">Off</span>
        </div>
        
        <button class="header-btn" onclick="showReport()" title="Laporan">üìä</button>
    </div>
  </header>

  <div class="layout-grid">
    <!-- KOLOM KIRI: AI & MENU -->
    <div class="main-column">
      
      <!-- AI INPUT PESAN CEPAT -->
      <div class="card-box ai-section">
        <div style="font-weight:700;color:var(--accent);display:flex;align-items:center;gap:6px; margin-bottom: 8px;">
          <span>‚ú® Pesan Cepat (AI)</span>
        </div>
        <textarea id="aiInput" class="ai-box" rows="2" placeholder="Contoh: A 10, KT 5, Gule 10rb"></textarea>
        <div class="ai-hint">
          <strong>Kode:</strong> <span class="code-tag">A</span>=Ayam, <span class="code-tag">K</span>=Kambing, <span class="code-tag">KT</span>=Kambing TL, <span class="code-tag">G</span>=Gule, <span class="code-tag">N</span>=Nasi
        </div>
        <button class="btn" style="margin-top:12px;padding:10px;font-size:13px;" onclick="parseAI()">Masukan ke Keranjang</button>
      </div>

      <div class="section-title">Makanan</div>
      <div class="menu-grid" id="foodGrid"></div>

      <div class="section-title" style="margin-top: 32px;">Minuman</div>
      <div class="menu-grid" id="drinkGrid"></div>
    </div>

    <!-- KOLOM KANAN: KERANJANG & STATS -->
    <div class="sidebar-column">
      <div class="card-box stats-grid">
        <div class="stat-card">
          <div class="stat-label">Omset</div>
          <div class="stat-val" id="omsetVal">Rp 0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Trx</div>
          <div class="stat-val" id="trxVal">0</div>
        </div>
      </div>

      <div class="cart-wrapper">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <span style="font-weight:700;font-size:18px;">Keranjang</span>
          <button onclick="resetCart()" style="background:none;border:none;color:var(--red);font-weight:600;">Reset</button>
        </div>
        
        <div id="cartList" style="min-height: 100px;">
            <div style="text-align:center;color:#ccc;padding:20px;">Kosong</div>
        </div>
        
        <input type="number" id="tableNum" class="money" style="font-size:16px;padding:10px;margin-top:10px;text-align:left;" placeholder="No. Meja (Opsional)">

        <div style="margin-top:20px; padding-top:16px; border-top:2px solid #f1f5f9;">
          <div style="display:flex;justify-content:space-between;font-weight:800;font-size:20px; color: #0f172a; margin-bottom: 16px;">
            <span>Total</span>
            <span id="cartTotal">Rp 0</span>
          </div>
          <button class="btn" onclick="showCheckout()">Bayar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RIWAYAT TRANSAKSI -->
  <div class="history-section" style="margin-top: 40px;">
    <div class="section-title">
      Riwayat
      <div style="display:flex;gap:8px">
        <button onclick="resetHistory()" style="font-size:11px;padding:6px 10px;border-radius:6px;border:none;background:#fee2e2;color:#991b1b;">Reset</button>
        <button onclick="exportExcel()" style="font-size:11px;padding:6px 10px;border-radius:6px;border:1px solid #cbd5e1;background:#fff;">Excel</button>
      </div>
    </div>
    <div class="table-container">
      <div style="overflow-x: auto;">
        <table id="historyTable"></table>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PEMBAYARAN -->
<div id="paymentModal" class="modal-overlay">
  <div class="modal-card">
    <h3 style="margin:0 0 10px;text-align:center;">Pembayaran</h3>
    <div class="total-display" id="modalTotal" style="font-size: 32px; font-weight:800; text-align:center; margin-bottom: 20px;">Rp 0</div>
    <input type="number" id="paidInput" class="money" placeholder="Uang Diterima">
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:20px;">
        <button class="btn secondary" style="margin:0; padding:10px;" onclick="addNol('00')">+00</button>
        <button class="btn secondary" style="margin:0; padding:10px;" onclick="addNol('000')">+000</button>
    </div>
    
    <div style="display:flex;justify-content:space-between;margin-bottom:24px;background:#f8fafc;padding:16px;border-radius:12px;">
      <span style="color:var(--muted)">Kembali:</span>
      <span id="changeDisplay" style="font-weight:700;">Rp 0</span>
    </div>

    <!-- TOMBOL AKSI -->
    <button class="btn" onclick="processTransaction(true)">üñ®Ô∏è Bayar & Print (BT)</button>
    <button class="btn secondary" onclick="processTransaction(false)">‚úÖ Bayar Tanpa Print</button>
    <button class="btn secondary" style="margin-top:10px; color:#ef4444; border-color:#fca5a5; background:#fef2f2;" onclick="document.getElementById('paymentModal').style.display='none'">Batal</button>
  </div>
</div>

<!-- MODAL SCAN PRINTER -->
<div id="scanModal" class="modal-overlay">
  <div class="modal-card">
    <h3>Pilih Printer Bluetooth</h3>
    <div id="scanStatus" style="font-size:12px;color:#666;margin-bottom:10px;">Mencari perangkat...</div>
    <ul id="deviceList"></ul>
    <button class="btn secondary" onclick="document.getElementById('scanModal').style.display='none'">Tutup</button>
  </div>
</div>

<!-- HALAMAN LAPORAN -->
<div id="reportPage" class="slide-up">
  <div class="report-header">
    <button class="header-btn" onclick="document.getElementById('reportPage').style.display='none'">‚¨Ö</button>
    <div>
      <h2 style="margin:0;font-size:18px;">Laporan Penjualan</h2>
      <div style="font-size:12px;color:var(--muted)">Ringkasan item terjual</div>
    </div>
  </div>
  <div class="report-container">
    <div id="reportContent" style="background:white; border-radius:16px; overflow: hidden; border:1px solid #e2e8f0;"></div>
  </div>
</div>

<script>
/* ================= DATA & CONFIG ================= */
const DATA_MENU = [
  // SATE KAMBING
  { id: 'sk_tusuk', keywords: ['sate kambing', 'kambing'], label: 'Sate Kambing (Tusuk)', price: 2400, category: 'food', visible: false },
  { id: 'sk_porsi', keywords: ['sate kambing porsi'], label: 'Sate Kambing (Porsi)', price: 24000, category: 'food', visible: true },
  
  // SATE KAMBING POLOS
  { id: 'sk_nl_tusuk', keywords: ['kambing tanpa lemak', 'no lemak', 'sk polos', 'kambing tl'], label: 'Sate Kambing TL (Tusuk)', price: 2600, category: 'food', visible: false },
  { id: 'sk_nl_porsi', keywords: ['kambing tanpa lemak porsi'], label: 'Sate Kambing TL (Porsi)', price: 26000, category: 'food', visible: true },

  // SATE AYAM
  { id: 'sa_tusuk', keywords: ['sate ayam', 'ayam'], label: 'Sate Ayam (Tusuk)', price: 1200, category: 'food', visible: false },
  { id: 'sa_porsi', keywords: ['sate ayam porsi'], label: 'Sate Ayam (Porsi)', price: 12000, category: 'food', visible: true },

  // GULE & NASI
  { id: 'gule', keywords: ['gule', 'gulai'], label: 'Gule (Porsi)', price: 24000, category: 'food', visible: true, isFlexible: true },
  { id: 'nasi_gule', keywords: ['nasi gule'], label: 'Nasi Gule', price: 14000, category: 'food', visible: true },
  { id: 'nasi', keywords: ['nasi', 'sego'], label: 'Nasi Putih', price: 3000, category: 'food', visible: true, isFlexible: true },
  { id: 'kerupuk', keywords: ['kerupuk'], label: 'Kerupuk', price: 1000, category: 'food', visible: true },

  // MINUMAN
  { id: 'es_teh', keywords: ['es teh'], label: 'Es Teh', price: 3000, category: 'drink', visible: true },
  { id: 'es_jeruk', keywords: ['es jeruk'], label: 'Es Jeruk', price: 3000, category: 'drink', visible: true },
  { id: 'teh_anget', keywords: ['teh anget'], label: 'Teh Anget', price: 3000, category: 'drink', visible: true },
  { id: 'jeruk_anget', keywords: ['jeruk anget'], label: 'Jeruk Anget', price: 3000, category: 'drink', visible: true }
];

let cart = [];
let transactions = JSON.parse(localStorage.getItem('trx_cak_sabar') || '[]');
let connectedPrinter = null; // Menyimpan alamat MAC printer yang terkoneksi
const formatRp = n => 'Rp ' + Number(n).toLocaleString('id-ID');

/* ================= INIT CORDOVA & APP ================= */
document.addEventListener('deviceready', onDeviceReady, false);

function onDeviceReady() {
    console.log("Cordova Ready!");
    // Coba auto-connect ke printer terakhir
    const lastPrinter = localStorage.getItem('lastPrinter');
    if (lastPrinter) {
        connectPrinter(lastPrinter, true); // True = silent mode
    }
}

// Render awal
renderMenuGrid();
updateStats();
renderHistory();

/* ================= BLUETOOTH LOGIC (CORDOVA) ================= */
function scanPrinters() {
    document.getElementById('scanModal').style.display = 'flex';
    const list = document.getElementById('deviceList');
    list.innerHTML = '';
    
    if (typeof bluetoothSerial === 'undefined') {
        list.innerHTML = '<li style="color:red">Fitur Bluetooth hanya jalan di APK Cordova!</li>';
        return;
    }

    bluetoothSerial.list(function(devices) {
        devices.forEach(function(device) {
            const li = document.createElement("li");
            li.innerHTML = `<div><b>${device.name}</b><br><small style="color:#666">${device.address}</small></div>`;
            li.onclick = function() { connectPrinter(device.address); };
            list.appendChild(li);
        });
        if(devices.length === 0) list.innerHTML = '<li style="padding:10px">Tidak ada perangkat yang dipairing. Silakan pair dulu di Setting Bluetooth HP.</li>';
    }, function(err) {
        list.innerHTML = '<li>Error Scan: ' + err + '</li>';
    });
}

function connectPrinter(address, silent = false) {
    if(!silent) document.getElementById('scanStatus').innerText = "Menghubungkan ke " + address + "...";
    
    bluetoothSerial.connect(address, function() {
        connectedPrinter = address;
        localStorage.setItem('lastPrinter', address);
        
        // Update UI Button
        const btn = document.getElementById('btnPrinter');
        btn.classList.add('connected');
        document.getElementById('iconPrinter').innerText = 'üñ®Ô∏è';
        document.getElementById('textPrinter').innerText = 'Ready';
        
        if(!silent) {
            document.getElementById('scanModal').style.display = 'none';
            // alert("Printer Terhubung!"); 
        }
    }, function(err) {
        if(!silent) alert("Gagal konek: " + err);
    });
}

function printToBluetooth(trxData) {
    if (typeof bluetoothSerial === 'undefined') {
        alert("Fitur ini butuh APK Cordova.");
        return;
    }
    if (!connectedPrinter) {
        alert("Printer belum terkoneksi. Klik tombol di pojok kanan atas.");
        return;
    }

    // ESC/POS COMMANDS
    const ESC = '\x1B';
    const GS = '\x1D';
    const INIT = ESC + '@';
    const ALIGN_CENTER = ESC + 'a' + '\x01';
    const ALIGN_LEFT = ESC + 'a' + '\x00';
    const BOLD_ON = ESC + 'E' + '\x01';
    const BOLD_OFF = ESC + 'E' + '\x00';
    const FEED = '\x0A';
    const CUT = GS + 'V' + '\x41' + '\x10';

    // Helper: Format Baris (Kiri ........ Kanan)
    const formatRow = (left, right) => {
        const width = 32; // Standard 58mm
        const space = Math.max(0, width - left.length - right.length);
        return left + " ".repeat(space) + right;
    };

    let receipt = "";
    receipt += INIT;
    receipt += ALIGN_CENTER + BOLD_ON + "WARUNG CAKSABAR" + BOLD_OFF + FEED;
    receipt += "Jl. Brigjen Katamso" + FEED;
    receipt += "--------------------------------" + FEED;
    receipt += ALIGN_LEFT;
    receipt += `Tgl : ${trxData.date}` + FEED;
    receipt += `Meja: ${trxData.tableNum}` + FEED;
    receipt += "--------------------------------" + FEED;

    trxData.items.forEach(item => {
        receipt += item.label + FEED;
        const line2 = `${item.qty} x ${item.price.toLocaleString()}`;
        const totalItem = (item.qty * item.price).toLocaleString();
        receipt += formatRow(line2, totalItem) + FEED;
    });

    receipt += "--------------------------------" + FEED;
    receipt += BOLD_ON;
    receipt += formatRow("TOTAL", trxData.total.toLocaleString()) + FEED;
    receipt += BOLD_OFF;
    receipt += formatRow("BAYAR", trxData.paid.toLocaleString()) + FEED;
    const kem = trxData.paid - trxData.total;
    receipt += formatRow("KEMBALI", (kem<0?0:kem).toLocaleString()) + FEED;
    receipt += FEED;
    receipt += ALIGN_CENTER + "Terima Kasih" + FEED;
    receipt += FEED + FEED + FEED; // Feed kertas

    bluetoothSerial.write(receipt, function() {
        // Success
    }, function(err) {
        alert("Gagal Print: " + err);
    });
}

/* ================= CORE FEATURES (RESTORED) ================= */

// 1. RENDER MENU
function renderMenuGrid() {
  const fGrid = document.getElementById('foodGrid');
  const dGrid = document.getElementById('drinkGrid');
  fGrid.innerHTML = ''; dGrid.innerHTML = '';

  DATA_MENU.forEach(item => {
    if (!item.visible) return;
    const el = document.createElement('div');
    el.className = 'menu-item';
    el.innerHTML = `
      <div class="m-name">${item.label}</div>
      <div class="menu-footer">
         <div class="m-price">${formatRp(item.price)}</div>
         <div id="controls_${item.id}"></div>
      </div>
    `;
    if (item.category === 'food') fGrid.appendChild(el); else dGrid.appendChild(el);
  });
  updateMenuUI();
}

function updateMenuUI() {
  DATA_MENU.forEach(item => {
    const container = document.getElementById(`controls_${item.id}`);
    if(!container) return;
    const cartItem = cart.find(c => c.id === item.id && c.price === item.price);
    const qty = cartItem ? cartItem.qty : 0;

    if (qty > 0) {
      container.innerHTML = `
        <div class="qty-controls">
           <button class="qty-btn minus" onclick="modCart('${item.id}', -1, ${item.price})">‚àí</button>
           <div class="qty-val">${qty}</div>
           <button class="qty-btn plus" onclick="modCart('${item.id}', 1, ${item.price})">+</button>
        </div>`;
    } else {
      container.innerHTML = `
         <button class="add-btn-simple" onclick="addToCartById('${item.id}')">
            <span>Tambah</span>
         </button>`;
    }
  });
}

// 2. CART LOGIC
function addToCartById(id) {
    const item = DATA_MENU.find(i => i.id === id);
    if(item) modCart(id, 1, item.price);
}

function modCart(id, delta, price) {
    const item = DATA_MENU.find(i => i.id === id);
    const existIdx = cart.findIndex(c => c.id === id && c.price === price);
    
    if (existIdx !== -1) {
        cart[existIdx].qty += delta;
        if (cart[existIdx].qty <= 0) cart.splice(existIdx, 1);
    } else if (delta > 0) {
        cart.push({ id: item.id, label: item.label, price: price, qty: delta });
    }
    renderCart();
}

function renderCart() {
    const list = document.getElementById('cartList');
    list.innerHTML = '';
    let total = 0;
    
    cart.forEach((c, idx) => {
        total += c.price * c.qty;
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = `
            <div class="c-name">${c.label} <small style="color:#64748b">@${formatRp(c.price)}</small></div>
            <div class="c-qty">x${c.qty}</div>
            <div style="font-weight:700">${formatRp(c.price*c.qty)}</div>
            <button onclick="cart.splice(${idx},1);renderCart()" style="border:none;background:none;color:red;font-weight:bold;margin-left:8px">√ó</button>
        `;
        list.appendChild(row);
    });
    
    if(cart.length===0) list.innerHTML = '<div style="text-align:center;color:#ccc;padding:20px;">Belum ada item</div>';
    document.getElementById('cartTotal').textContent = formatRp(total);
    updateMenuUI();
}

function resetCart() {
    cart = [];
    renderCart();
    document.getElementById('aiInput').value = '';
    document.getElementById('tableNum').value = '';
}

// 3. AI PARSER
function parseAI() {
  let text = document.getElementById('aiInput').value.toLowerCase();
  text = text.replace(/rb/g, '000').replace(/\ba\b/g, 'sate ayam').replace(/\bk\b/g, 'sate kambing').replace(/\bkt\b/g, 'kambing tanpa lemak').replace(/\bg\b/g, 'gule').replace(/\bn\b/g, 'nasi');
  
  if (!text.trim()) return;
  const orders = text.split(/[\n,]+/);
  
  orders.forEach(raw => {
    const line = raw.trim(); if (!line) return;
    let numbers = line.match(/\d+(\.\d+)?/g); 
    let numericValues = numbers ? numbers.map(n => parseInt(n.replace(/\./g, ''))) : [1];
    let qty = 1; let customPrice = null;

    numericValues.forEach(val => { if (val > 500) customPrice = val; else qty = val; });

    let bestMatch = null; let maxScore = 0;
    DATA_MENU.forEach(item => {
      item.keywords.forEach(key => {
        if (line.includes(key) && key.length > maxScore) { maxScore = key.length; bestMatch = item; }
      });
    });

    if (bestMatch) {
      if (customPrice && bestMatch.isFlexible) modCart(bestMatch.id, 1, customPrice);
      else if (customPrice && !bestMatch.isFlexible) {
         let calcQty = Math.floor(customPrice / bestMatch.price);
         if(calcQty > 0) modCart(bestMatch.id, calcQty, bestMatch.price);
      } else modCart(bestMatch.id, qty, bestMatch.price);
    }
  });
  document.getElementById('aiInput').value = '';
}

// 4. CHECKOUT
function showCheckout() {
    if(cart.length === 0) return alert("Keranjang kosong");
    const total = cart.reduce((a,b)=>a+(b.price*b.qty),0);
    document.getElementById('modalTotal').textContent = formatRp(total);
    document.getElementById('paymentModal').style.display = 'flex';
    
    const inp = document.getElementById('paidInput');
    inp.value = '';
    inp.oninput = (e) => {
        const val = parseInt(e.target.value)||0;
        document.getElementById('changeDisplay').textContent = formatRp(val - total);
    };
    setTimeout(()=>inp.focus(), 100);
}

function addNol(n) {
    const inp = document.getElementById('paidInput');
    inp.value += n;
    inp.dispatchEvent(new Event('input'));
}

function processTransaction(print) {
    const total = cart.reduce((a,b)=>a+(b.price*b.qty),0);
    const paid = parseInt(document.getElementById('paidInput').value) || 0;
    const table = document.getElementById('tableNum').value || '-';
    
    if(paid < total && paid !== 0) {
        if(!confirm("Uang kurang! Lanjut?")) return;
    }

    const trx = {
        id: Date.now(),
        date: new Date().toLocaleString('id-ID'),
        tableNum: table,
        items: [...cart],
        total: total,
        paid: paid
    };

    transactions.unshift(trx);
    localStorage.setItem('trx_cak_sabar', JSON.stringify(transactions));
    
    if(print) printToBluetooth(trx);
    
    resetCart();
    document.getElementById('paymentModal').style.display = 'none';
    updateStats();
    renderHistory();
    alert("Transaksi Berhasil!");
}

// 5. HISTORY & REPORT
function updateStats() {
    const today = new Date().toLocaleDateString('id-ID');
    const todayTrx = transactions.filter(t => t.date.includes(today));
    const total = todayTrx.reduce((a,b)=>a+b.total,0);
    document.getElementById('omsetVal').textContent = formatRp(total);
    document.getElementById('trxVal').textContent = todayTrx.length;
}

function renderHistory() {
    const tbl = document.getElementById('historyTable');
    tbl.innerHTML = `<tr><th>Waktu</th><th>Total</th><th>Aksi</th></tr>`;
    
    transactions.slice(0, 10).forEach(t => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><small>${t.date}</small><br><b>${t.tableNum !== '-' ? 'Meja '+t.tableNum : ''}</b></td>
            <td style="font-weight:bold;color:var(--accent)">${formatRp(t.total)}</td>
            <td>
                <button class="action-btn edit" onclick="editTrx(${t.id})">‚úèÔ∏è</button>
                <button class="action-btn del" onclick="delTrx(${t.id})">üóëÔ∏è</button>
            </td>
        `;
        tbl.appendChild(row);
    });
}

function delTrx(id) {
    if(!confirm("Hapus transaksi ini?")) return;
    transactions = transactions.filter(t => t.id !== id);
    localStorage.setItem('trx_cak_sabar', JSON.stringify(transactions));
    renderHistory();
    updateStats();
}

function editTrx(id) {
    if(cart.length > 0 && !confirm("Keranjang akan ditimpa. Lanjut?")) return;
    const trx = transactions.find(t => t.id === id);
    if(trx) {
        cart = [...trx.items];
        document.getElementById('tableNum').value = trx.tableNum !== '-' ? trx.tableNum : '';
        delTrx(id); // Hapus yang lama
        renderCart();
    }
}

function resetHistory() {
    if(confirm("Hapus SEMUA riwayat?")) {
        transactions = [];
        localStorage.setItem('trx_cak_sabar', JSON.stringify([]));
        renderHistory();
        updateStats();
    }
}

function showReport() {
    document.getElementById('reportPage').style.display = 'flex';
    // Logic report sama seperti sebelumnya...
    const container = document.getElementById('reportContent');
    let foodHtml = '', drinkHtml = '', tFood = 0, tDrink = 0;
    
    // Agregasi Data
    const stats = {};
    transactions.forEach(t => t.items.forEach(i => {
        const key = i.id + '_' + i.price;
        if(!stats[key]) stats[key] = { ...i, qty: 0 };
        stats[key].qty += i.qty;
    }));
    
    Object.values(stats).forEach(i => {
        let label = i.label;
        let qtyDisplay = i.qty;
        
        // Logic Porsi ke Tusuk
        if(['sk_porsi','sa_porsi','sk_nl_porsi'].includes(i.id)) {
            qtyDisplay = `${i.qty} Porsi <span style="font-weight:bold;color:var(--accent)">(${i.qty*10} Tusuk)</span>`;
        } else if(i.id.includes('tusuk')) {
            qtyDisplay = `${i.qty} Tusuk`;
        }

        const row = `<div style="padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between">
            <div>${label}<br><small>@${formatRp(i.price)}</small></div>
            <div>${qtyDisplay}</div>
        </div>`;
        
        if(DATA_MENU.find(m=>m.id===i.id)?.category === 'drink') {
            drinkHtml += row; tDrink += i.qty;
        } else {
            foodHtml += row; tFood += i.qty;
        }
    });

    container.innerHTML = `
        <div class="report-group-header">Makanan (${tFood})</div>${foodHtml}
        <div class="report-group-header">Minuman (${tDrink})</div>${drinkHtml}
    `;
}

function exportExcel() {
  const data = transactions.map(t => ({
    Tanggal: t.date, Meja: t.tableNum, Total: t.total,
    Item: t.items.map(i => `${i.label} (${i.qty})`).join('; ')
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Laporan");
  XLSX.writeFile(wb, "Laporan_Caksabar.xlsx");
}
</script>
</body>
</html>
